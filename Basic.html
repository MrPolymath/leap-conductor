<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<!-- polyfill -->
	<script src="inc/shim/Base64.js" type="text/javascript"></script>
	<script src="inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="js/midi/gm.js" type="text/javascript"></script>
	<script src="js/midi/loader.js" type="text/javascript"></script>
	<script src="js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<img src="./logo.png" width="400px"/>
<script type="text/javascript">
	var keys_down = [];
	var oldStreamReceived = [{instrument:'acoustic_grand_piano',note:'59',volume:'127'},{instrument:'acoustic_grand_piano',note:'79',volume:'120'}]
	var streamReceived = [{instrument:'acoustic_grand_piano',note:'55',volume:'127'},{instrument:'acoustic_grand_piano',note:'45',volume:'120'}]
	var tempo = streamReceived[0].tempo
	var lastReceived = streamReceived
	var newElements = []
	var oldElements = []
	var newProve = true
	var oldProve = true


	function newElement(old, neww){
		console.log(old, neww);
		var result = [];
		neww.forEach(function (a) {
			old.forEach(function(b,i){
				console.log(JSON.stringify(a))
				console.log(JSON.stringify(b));
				if(JSON.stringify(a) === JSON.stringify(b)){ newProve = false}
				if(i == old.length-1){
					if(newProve === true){
						console.log('Sha de comencar un nou to');
						result.push(a)}
					else{newProve = true; console.log('No sinicialitza');}
				}
			})
		});
		return result
	}
	function oldElement(old, neww){
		var result = []
		old.forEach(function (a) {
			neww.forEach(function(b,i){
				console.log(JSON.stringify(a))
				console.log(JSON.stringify(b));
				if(JSON.stringify(a) === JSON.stringify(b)){ oldProve = false}
				if(i == neww.length-1){
					if(oldProve === true){
						console.log('Sha de tancar el to');
						result.push(a)}
					else{oldProve = true; console.log('No sha de tancar');}
				}
		});
	})
	return result
}
	window.onload = function () {
		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instrument:  "acoustic_grand_piano",
			onprogress: function(state, progress) {
				console.log(state, progress);
			},
			onsuccess: function() {
				MIDI.noteOn(0, '70', '127', 0);

				console.log("success");
				setInterval(function(){
					newElements = newElement(oldStreamReceived,streamReceived)
					oldElements = oldElement(oldStreamReceived,streamReceived)
					for (var j = 0; j < newElements.length; j++){
						console.log("midiOn");
						MIDI.noteOn(0, newElements[j].note, newElements[j].volume, 0);
						MIDI.noteOn(0, '70', '127', 0);
					}
					for (var j = 0; j < oldElements.length; j++){
						MIDI.noteOff(0, oldElements[j].note, 0);
					}
					oldStreamReceived = streamReceived
					streamReceived = [{instrument:'acoustic_grand_piano',note:'37',volume:'127'}]
					newElements = []
					oldElements = []
					newProve = true
					oldProve = true

				}, 1000)
			}
		});
	};

</script>
</body>
</html>
